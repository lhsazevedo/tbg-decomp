name: Test

on: ['push', 'pull_request']

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install wibo
        run: |
          wget -nv https://github.com/decompals/wibo/releases/latest/download/wibo-x86_64 -O wibo
          sudo mv wibo /usr/local/bin/wibo
          sudo chmod +x /usr/local/bin/wibo

      - name: Install sh4objtest
        run: |
          wget -nv https://github.com/lhsazevedo/sh4objtest/releases/latest/download/sh4objtest-linux-x86_64.tar.gz
          tar -xzf sh4objtest-linux-x86_64.tar.gz
          mv sh4objtest /usr/local/bin/sh4objtest
          rm sh4objtest-linux-x86_64.tar.gz

      - name: Checkout SDK
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.SDK_REPO_KEY }}
          repository: lhsazevedo/dc-sdk-155j
          path: sdk

      - name: Configure environment
        run: |
          DC_SDK=$PWD/sdk
          mkdir -p $PWD/build/tmp
          echo "SHINOBI_DIR=$(wibo path -w $DC_SDK/shinobi)" >> "$GITHUB_ENV"
          echo "KATANA_SDK_DIR=$(wibo path -w $DC_SDK)" >> "$GITHUB_ENV"
          echo "SHC_BIN=$(wibo path -w $DC_SDK/shc/bin)" >> "$GITHUB_ENV"
          echo "SHC_TMP=$(wibo path -w $PWD/build/tmp)" >> "$GITHUB_ENV"
          echo "SHC_LIB=$(wibo path -w $DC_SDK/shc/bin)" >> "$GITHUB_ENV"
          echo "SHC_INC=$(wibo path -w $DC_SDK/shc/include),$(wibo path -w $DC_SDK/shinobi/include)" >> "$GITHUB_ENV"

      - name: Test
        run: bash scripts/run_tests.sh
